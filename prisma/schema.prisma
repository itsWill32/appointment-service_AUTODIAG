// This is your Prisma schema file for Appointment Service
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// APPOINTMENT SERVICE MODELS
// ============================================

model Appointment {
  id          String   @id @default(uuid())
  
  // References to other services
  userId      String   // FK to Auth Service
  vehicleId   String   // FK to Vehicle Service
  workshopId  String   // FK to Workshop Service
  diagnosisId String?  // FK to Diagnosis Service (optional)
  
  // Appointment details
  serviceType String
  description String?
  
  // Scheduling
  scheduledDate DateTime
  scheduledTime String   // "14:00"
  estimatedDuration Int? // Minutes
  
  // Status
  status      AppointmentStatus @default(PENDING)
  
  // Costs
  estimatedCost Float?
  finalCost     Float?
  
  // Progress tracking
  progress    AppointmentProgress[]
  
  // Communication
  messages    ChatMessage[]
  
  // Cancellation
  cancelledAt DateTime?
  cancelReason String?
  cancelledBy String?  // 'customer' | 'workshop'
  
  // Completion
  completedAt DateTime?
  notes       String?
  
  // Photos/documents
  photos      String[]
  documents   String[]
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
  @@index([vehicleId])
  @@index([workshopId])
  @@index([status])
  @@index([scheduledDate])
  @@map("appointments")
}

enum AppointmentStatus {
  PENDING           // Pendiente de confirmación
  CONFIRMED         // Confirmada
  IN_PROGRESS       // En progreso
  WAITING_PARTS     // Esperando repuestos
  COMPLETED         // Completada
  CANCELLED         // Cancelada
  NO_SHOW           // Cliente no se presentó
}

// ============================================
// APPOINTMENT PROGRESS TRACKING
// ============================================

model AppointmentProgress {
  id            String   @id @default(uuid())
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  // Progress details
  stage         ProgressStage
  description   String?
  
  // Photos
  photos        String[]
  
  // Estimated completion
  estimatedCompletion DateTime?
  
  // Created by
  createdBy     String   // userId (mechanic)
  
  // Timestamps
  createdAt     DateTime @default(now())
  
  @@index([appointmentId])
  @@index([stage])
  @@map("appointment_progress")
}

enum ProgressStage {
  RECEIVED          // Vehículo recibido
  DIAGNOSIS         // En diagnóstico
  DIAGNOSIS_COMPLETE // Diagnóstico completo
  PARTS_ORDERED     // Piezas ordenadas
  IN_REPAIR         // En reparación
  QUALITY_CHECK     // Control de calidad
  READY             // Listo para recoger
}

// ============================================
// CHAT MESSAGES
// ============================================

model ChatMessage {
  id            String   @id @default(uuid())
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  
  // Message details
  senderId      String   // userId
  senderRole    String   // 'customer' | 'mechanic' | 'admin'
  message       String
  
  // Attachments
  attachments   String[] // URLs to photos/documents
  
  // Read status
  isRead        Boolean  @default(false)
  readAt        DateTime?
  
  // Timestamps
  createdAt     DateTime @default(now())
  
  @@index([appointmentId])
  @@index([senderId])
  @@index([createdAt])
  @@map("chat_messages")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(uuid())
  userId    String   // FK to Auth Service
  
  // Notification details
  type      NotificationType
  title     String
  message   String
  
  // Related entities
  appointmentId String?
  
  // Delivery
  channels  String[] // ['email', 'push', 'sms']
  
  // Status
  isRead    Boolean  @default(false)
  readAt    DateTime?
  
  isSent    Boolean  @default(false)
  sentAt    DateTime?
  
  // Metadata
  metadata  Json?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@map("notifications")
}

enum NotificationType {
  APPOINTMENT_CONFIRMED
  APPOINTMENT_REMINDER
  APPOINTMENT_STARTED
  APPOINTMENT_PROGRESS
  APPOINTMENT_COMPLETED
  APPOINTMENT_CANCELLED
  MESSAGE_RECEIVED
  REVIEW_REQUEST
}
